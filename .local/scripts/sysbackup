#!/usr/bin/env bash
set -euo pipefail

# === CONFIG ===
BACKUP_ROOT="/run/media/$USER/BACKUP"
MIRROR_DIR="$BACKUP_ROOT/system_mirror"
ARCHIVE_NAME="arch_backup_$(date +%F).tar.xz"
EXCLUDES=(
	"/proc"
	"/sys"
	"/dev"
	"/run"
	"/tmp"
	"/mnt"
	"/lost+found"
	"/var/cache"
	"/home/*/.cache"
	"/home/*/.local/share/Trash"
	"**/__pycache__"
	"**/node_modules"
	"**/.venv"
)

# === PRECHECKS ===
if [[ $EUID -ne 0 ]]; then
	echo "Please run this script as root (sudo) to preserve permissions."
	exit 1
fi

if [[ ! -d "$BACKUO_ROOT" ]]; then
	echo "Backup root $BACKUP_ROOT not found. Make sure your drive is mounted."
	exit 1
fi

mkdir -p "$MIRROR_DIR"

# === RSYNC MIRROR STEP ===
echo "[*] Starting rsync mirror..."
EXCLUDE_ARGS=()
for e in "${EXCLUDES[@]}"; do
	EXCLUDE_ARGS+=(--exclude="$e")
done

rsync -aAXHv --delete "${EXCLUDE_ARGS[@]}" / "$MIRROR_DIR"

# === TAR COMPRESSION STEP ===
echo "[*] Compressing backup into $ARCHIVE_NAME..."
tar -cvpaf "$ARCHIVE_NAME" system_mirror

echo "[âœ“] Backup complete: $BACKUP_ROOT/$ARCHIVE_NAME"
